<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thi tr·ª±c tuy·∫øn ‚Äî Demo (header removed)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --white:#ffffff;
      --card:#f7fbff;
      --accent:#0ea5b7;
      --muted:#64748b;
      --success:#10b981;
      --warning:#f59e0b;
      --shadow: 0 10px 30px rgba(2,6,23,0.08);
      --footer-blue-start: #0b2e6b;
      --footer-blue-end: #062969;
      --footer-height: 120px; /* default, s·∫Ω c·∫≠p nh·∫≠t b·∫±ng JS */
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--white); color:#0b1220}

    /* Candidate strip (moved to top since header removed) */
    .candidate-strip{
      width:100%;
      box-sizing:border-box;
      background:#0f274a; color:#eaf6ff; padding:12px 20px; border-radius:0;
      display:flex; justify-content:space-between; align-items:center; gap:12px; box-shadow:var(--shadow);
    }
    .candidate-inner{ max-width:1400px; margin:0 auto; width:100%; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .candidate-info{ display:flex; gap:14px; align-items:center; font-size:13px; }
    .candidate-info .name{ font-weight:700; color:#fff; }
    .candidate-controls{ display:flex; gap:8px; align-items:center; }
    .btn-primary{ background:var(--accent); color:#042024; border:0; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.12); padding:8px 10px; border-radius:8px; color:#eaf6ff; cursor:pointer; }
    .timer-bubble{ background: rgba(255,255,255,0.08); padding:6px 10px; border-radius:20px; font-weight:700; color:#fff; }

    /* page content: full width layout */
    .page-wrap{
      max-width: none;           /* remove max-width to allow full width */
      width: calc(100% - 36px);  /* keep small side gutters */
      margin:18px auto 0;
      padding:18px;
      background:var(--card);
      border-radius:10px;
      box-shadow:var(--shadow);
      /* reserve space at bottom so footer kh√¥ng che ph·∫ßn t·ª≠ cu·ªëi */
      padding-bottom: calc(var(--footer-height) + 20px);
    }

    .content h1{ margin:0 0 14px 0; text-align:center; font-size:18px; color:#08263b; }

    /* Score panel */
    .score-panel{ display:none; background:#fff; border-radius:10px; padding:14px; box-shadow: 0 14px 40px rgba(2,6,23,0.08); border:1px solid rgba(2,6,23,0.04); margin-bottom:12px; }
    .score-title{ font-weight:800; font-size:18px; color:#09324a; }
    .score-sub{ color:#334155; font-weight:600 }
    .score-table{ width:100%; border-collapse:collapse; margin-top:10px; color:#334155; }
    .score-table th, .score-table td{ padding:10px; border:1px solid rgba(2,6,23,0.06); text-align:center; }
    .score-table th{ background:rgba(2,6,23,0.02); font-weight:700; }

    /* quiz area */
    .quiz-area{ position:relative; }
    .quiz-wrapper{ padding:8px 2px; max-width:1400px; margin:0 auto; } /* center content within wide page */
    .question{ background:#fff; border-radius:8px; padding:12px; margin-bottom:12px; border:1px solid rgba(2,6,23,0.04); display:block; box-shadow: 0 6px 20px rgba(2,6,23,0.03); }
    .q-head{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .q-left{ display:flex; gap:10px; align-items:center; }
    .qnum{ width:36px; height:36px; border-radius:8px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-weight:700; color:#0b1220; }
    .qtitle{ font-weight:600; color:#0b1220; }
    .flag-btn{ background:transparent; border:1px solid rgba(2,6,23,0.05); padding:6px 8px; border-radius:8px; cursor:pointer; }
    .options{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    label.option{ display:flex; align-items:center; gap:8px; padding:10px; border-radius:8px; border:1px solid rgba(2,6,23,0.04); cursor:pointer; background:#fff; }
    input[type="number"]{ padding:8px; border-radius:6px; border:1px solid rgba(2,6,23,0.06); width:160px; }

    /* TF table styling (adjusted column widths) */
    .tf-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-top:8px; }
    .tf-table th, .tf-table td{ padding:8px; border:1px solid rgba(2,6,23,0.06); vertical-align:middle; }
    .tf-table thead th:nth-child(1){ width:34px; max-width:34px; text-align:center; } /* √ù */
    .tf-table thead th:nth-child(2){ width:auto; } /* Ph√°t bi·ªÉu (r·ªông) */
    .tf-table thead th:nth-child(3), .tf-table thead th:nth-child(4){ width:60px; max-width:60px; text-align:center; } /* ƒê√∫ng / Sai */
    .tf-table td:nth-child(2){ white-space:normal; word-wrap:break-word; } /* cho c·ªôt ph√°t bi·ªÉu xu·ªëng h√†ng n·∫øu d√†i */

    /* overlay only for quiz area */
    .quiz-overlay{ position:absolute; inset:0; background:rgba(0,0,0,0.45); z-index:40; display:flex; align-items:center; justify-content:center; border-radius:8px; }
    .quiz-overlay.hidden{ display:none; }
    .quiz-overlay .msg{ background:rgba(255,255,255,0.06); color:#fff; padding:16px 18px; border-radius:8px; font-weight:700; }

    /* footer area (green background) */
    .site-footer{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, var(--footer-blue-start), var(--footer-blue-end));
      padding: 14px 0;
      display: flex;
      justify-content: center;
      z-index: 80;
      box-shadow: 0 -8px 30px rgba(0,0,0,0.25);
    }
    .footer-inner{
      width: 100%;
      max-width: 1400px;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 20px;
      background: linear-gradient(180deg, #0d47a1, #083a8c);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
    }
    .bubbles-wrap{ display: flex; gap: 8px; align-items: center; flex-wrap:wrap;}
    .bubble{
       width: 34px;
      height: 34px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 700;
      cursor: pointer;
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.1);
    }
    .bubble.done{ background: linear-gradient(180deg,#22c55e,#10b981);
      color: #07211a;
      border-color: rgba(0,0,0,0.09); }
    .bubble.flagged{ background: linear-gradient(180deg,#f59e0b,#f97316);
      color: #2b1700;
      border-color: rgba(0,0,0,0.09); }

    .footer-note{ color: #fff; font-size: 13px; margin-left: 12px; opacity: 0.95; }

    /* small controls */
    .controls{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-bottom:12px; }
    .primary{ background:var(--accent); color:#042024; padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .ghost{ background:transparent; border:1px solid rgba(2,6,23,0.06); padding:8px 12px; border-radius:8px; cursor:pointer; }

    @media (max-width:900px){
      .candidate-inner{ flex-direction:column; align-items:flex-start; gap:8px; }
      .page-wrap{ width: calc(100% - 20px); margin:12px; padding:12px; }
      .footer-inner{ padding:6px }
      .bubble{ width:30px; height:30px; font-size:13px }
      .tf-table thead th:nth-child(1), .tf-table thead th:nth-child(3), .tf-table thead th:nth-child(4){ width:28px; }
    }
  </style>
</head>
<body>
  <!-- Candidate strip moved to top (header removed) -->
  <div class="candidate-strip" role="region" aria-label="Th√¥ng tin th√≠ sinh">
    <div class="candidate-inner">
      <div class="candidate-info">
        <div class="name" id="candName">Nguy·ªÖn VƒÉn A</div>
        <div>SBD: <strong id="candSBD">00000001</strong></div>
        <div>M√¥n thi: <strong id="candSub">TO√ÅN H·ªåC</strong></div>
        <div>Ng√†y thi: <strong id="candDate">10/09/2025</strong></div>
        <div>Ca thi: <strong id="candShift">8</strong></div>
      </div>

      <div class="candidate-controls">
        <div class="timer-bubble" id="timerHeader">90:00</div>
        <button class="btn-ghost" id="connStatus">üîå ƒêang k·∫øt n·ªëi</button>
        <!-- G·ªôp: n√∫t N·ªòP B√ÄI duy nh·∫•t ·ªü tr√™n c√πng -->
        <button class="btn-primary" id="submitTopBtn">N·ªòP B√ÄI</button>
        <button class="btn-ghost" title="To√†n m√†n h√¨nh" onclick="document.documentElement.requestFullscreen()">‚§¢</button>
      </div>
    </div>
  </div>

  <!-- Content -->
  <main class="page-wrap" id="pageWrap">
    <div class="content panel" id="contentPanel">
      <h1>GIAO DI·ªÜN L√ÄM B√ÄI C·ª¶A TH√ç SINH</h1>

      <!-- Score panel -->
      <section id="scoreBanner" class="score-panel" aria-live="polite"></section>

      <!-- Controls -->
      <div class="controls">
        <!-- Hi·ªÉn th·ªã d·∫°ng: ƒê√£ l√†m X / T·ªïng s·ªë -->
        <div style="color:var(--muted); align-self:center">ƒê√£ l√†m: <strong id="totalQ">0/...</strong></div>
        <button class="ghost" id="saveBtn">L∆∞u t·∫°m</button>
        <button class="ghost" id="clearBtn">X√≥a d·ªØ li·ªáu</button>
        <!-- B·ªè n√∫t N·ªôp b√†i ·ªü ch√¢n (ƒë√£ g·ªôp l√™n ƒë·∫ßu) -->
      </div>

      <!-- Quiz area -->
      <section class="quiz-area">
        <div class="quiz-wrapper" id="quizWrapper">
          <form id="quizForm" autocomplete="off">
            <div id="part1" class="section"><h3>Ph·∫ßn 1. Th√≠ sinh ch·ªçn 1 trong 4 ph∆∞∆°ng √°n A, B, C ho·∫∑c D</h3></div>
            <div id="part2" class="section"><h3>Ph·∫ßn 2. Th√≠ sinh l·ª±a ch·ªçn ƒê√∫ng ho·∫∑c Sai trong m·ªói √Ω</h3></div>
            <div id="part3" class="section"><h3>Ph·∫ßn 3. Th√≠ sinh th·ª±c hi·ªán c√°c c√¢u h·ªèi b√™n d∆∞·ªõi</h3></div>
          </form>
        </div>

        <div id="quizOverlay" class="quiz-overlay hidden" aria-hidden="true"><div class="msg">B√†i ƒë√£ n·ªôp ‚Äî kh√¥ng th·ªÉ ch·ªânh s·ª≠a n·ªØa</div></div>
      </section>
    </div>
  </main>

  <!-- FOOTER (green background) -->
  <footer class="site-footer" role="contentinfo" id="siteFooter">
    <div class="footer-inner" id="footerBubbles">
      <div class="bubbles-wrap" id="bubblesWrap"></div>
      <div class="footer-note" id="footerNote">ƒê√£ l√†m: <span id="footerTotal">0/...</span></div>
    </div>
  </footer>

  <script>
    /* ===== CONFIG ===== */
    const MCQ_COUNT = 12;
    const TF_COUNT = 4;
    const TF_ITEMS = 4;
    const SHORT_COUNT = 6;
    const TOTAL_Q = MCQ_COUNT + TF_COUNT + SHORT_COUNT;

    const correct = {
      mcq: {1:'C',2:'B',3:'A',4:'A',5:'B',6:'C',7:'D',8:'A',9:'B',10:'C',11:'A',12:'B'},
      tf: {1: [true,false,true,false],2: [true,true,false,false],3: [false,true,true,true],4: [true,false,false,true]},
      short: {1:11,2:180,3:42,4:7,5:100,6:3}
    };

    /* ===== STATE ===== */
    let flagged = {};
    let submitted = false;

    /* DOM refs & initial text */
    document.getElementById('totalQ').textContent = `0/${TOTAL_Q}`;
    document.getElementById('footerTotal').textContent = `0/${TOTAL_Q}`;

    /* RENDER QUESTIONS */
    function renderQuestions(){
      const part1 = document.getElementById('part1');
      for(let i=1;i<=MCQ_COUNT;i++){
        const qNum = i;
        const q = document.createElement('div'); q.className='question'; q.dataset.qnum = qNum;
        q.innerHTML = `
          <div class="q-head">
            <div class="q-left"><div class="qnum">${qNum}</div><div class="qtitle">C√¢u ${qNum}: N·ªôi dung c√¢u h·ªèi ${qNum}</div></div>
            <div><button type="button" class="flag-btn" onclick="toggleFlag(${qNum}, this)">üö© G·∫Øn c·ªù</button></div>
          </div>
          <div class="options">
            <label class="option"><input type="radio" name="p1q${i}" value="A"> A. ƒê√°p √°n A</label>
            <label class="option"><input type="radio" name="p1q${i}" value="B"> B. ƒê√°p √°n B</label>
            <label class="option"><input type="radio" name="p1q${i}" value="C"> C. ƒê√°p √°n C</label>
            <label class="option"><input type="radio" name="p1q${i}" value="D"> D. ƒê√°p √°n D</label>
          </div>`;
        part1.appendChild(q);
      }

      const part2 = document.getElementById('part2');
      for(let i=1;i<=TF_COUNT;i++){
        const qNum = MCQ_COUNT + i;
        const q = document.createElement('div'); q.className='question'; q.dataset.qnum = qNum;
        // use class tf-table so we can control column widths in CSS
        let table = `<table class="tf-table"><thead><tr><th>√ù</th><th>Ph√°t bi·ªÉu</th><th>ƒê√∫ng</th><th>Sai</th></tr></thead><tbody>`;
        for(let j=1;j<=TF_ITEMS;j++){
          table += `<tr><td style="padding:8px;text-align:center">${String.fromCharCode(96+j)}</td><td style="padding:8px">Ph√°t bi·ªÉu ${j} (n·ªôi dung c√≥ th·ªÉ d√†i, c·ªôt n√†y r·ªông h∆°n ƒë·ªÉ hi·ªÉn th·ªã r√µ)</td><td style="padding:8px;text-align:center"><input type="radio" name="p2q${i}y${j}" value="true"></td><td style="padding:8px;text-align:center"><input type="radio" name="p2q${i}y${j}" value="false"></td></tr>`;
        }
        table += '</tbody></table>';
        q.innerHTML = `
          <div class="q-head">
            <div class="q-left"><div class="qnum">${qNum}</div><div class="qtitle">C√¢u ${qNum}: V·ªÅ ch·ªß ƒë·ªÅ ${qNum}</div></div>
            <div><button type="button" class="flag-btn" onclick="toggleFlag(${qNum}, this)">üö© G·∫Øn c·ªù</button></div>
          </div>
          <div style="margin-top:8px">${table}</div>`;
        part2.appendChild(q);
      }

      const part3 = document.getElementById('part3');
      for(let i=1;i<=SHORT_COUNT;i++){
        const qNum = MCQ_COUNT + TF_COUNT + i;
        const q = document.createElement('div'); q.className='question'; q.dataset.qnum = qNum;
        q.innerHTML = `
          <div class="q-head">
            <div class="q-left"><div class="qnum">${qNum}</div><div class="qtitle">C√¢u ${qNum}: Tr·∫£ l·ªùi (nh·∫≠p s·ªë)</div></div>
            <div><button type="button" class="flag-btn" onclick="toggleFlag(${qNum}, this)">üö© G·∫Øn c·ªù</button></div>
          </div>
          <div style="margin-top:8px"><input type="number" name="p3q${i}" placeholder="Nh·∫≠p ƒë√°p √°n d·∫°ng s·ªë"></div>`;
        part3.appendChild(q);
      }

      // After questions are rendered, enable MCQ toggle behavior
      enableMcqToggle();
      enableFocusScrolling(); // ƒë·∫£m b·∫£o focus input c√≥ th·ªÉ scroll n·∫øu c·∫ßn (ph√≤ng tr∆∞·ªùng h·ª£p)
    }
    renderQuestions();

    /* Enable toggle (uncheck) behavior for MCQ radio buttons:
       click again on a selected option -> it becomes unselected.
    */
    function enableMcqToggle(){
      const radios = document.querySelectorAll("input[type='radio'][name^='p1q']");
      radios.forEach(radio=>{
        radio.addEventListener('mousedown', function(){ this._wasChecked = this.checked; });
        radio.addEventListener('click', function(e){
          if(this._wasChecked){
            this.checked = false;
            this.dispatchEvent(new Event('change', { bubbles: true }));
            e.preventDefault();
          }
        });
      });
    }

    /* optional: when an input gains focus, ensure it's visible (won't be under footer)
       Because we set large bottom padding matching footer height, this is mostly precautionary.
    */
    function enableFocusScrolling(){
      const inputs = document.querySelectorAll('#quizWrapper input, #quizWrapper textarea, #quizWrapper select');
      inputs.forEach(inp=>{
        inp.addEventListener('focus', (ev)=>{
          // small timeout so layout adjustments (if any) have applied
          setTimeout(()=>{
            const footerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--footer-height')) || 120;
            const rect = inp.getBoundingClientRect();
            // if bottom of element is lower than viewport height - footer height - 16px, scroll it up
            const viewportAvailable = window.innerHeight - footerH - 24;
            if(rect.bottom > viewportAvailable){
              const delta = rect.bottom - viewportAvailable + 12;
              window.scrollBy({ top: delta, behavior: 'smooth' });
            }
          }, 80);
        }, {passive:true});
      });
    }

    /* FLAG */
    function toggleFlag(qNum, btn){
      flagged[qNum] = !flagged[qNum];
      if(btn){ btn.textContent = flagged[qNum] ? 'üö© B·ªè c·ªù' : 'üö© G·∫Øn c·ªù'; }
      updateFooterBubble(qNum);
      updateAnsweredCount();
    }
    window.toggleFlag = toggleFlag;

    /* FOOTER SIZE HANDLING: ƒë·∫£m b·∫£o .page-wrap c√≥ padding-bottom ƒë·ªß l·ªõn ƒë·ªÉ footer kh√¥ng che n·ªôi dung */
    function updateFooterHeight(){
      const footer = document.getElementById('siteFooter');
      if(!footer) return;
      // compute outer height
      const h = footer.offsetHeight || 120;
      document.documentElement.style.setProperty('--footer-height', h + 'px');
      // also ensure pageWrap padding-bottom updated (CSS uses var(--footer-height))
      // no further DOM change needed since CSS references the var
    }
    window.addEventListener('resize', ()=>{ updateFooterHeight(); });
    window.addEventListener('load', ()=>{ updateFooterHeight(); setTimeout(updateFooterHeight, 300); });

    /* TIMER & SAVE/LOAD (gi·ªØ nguy√™n logic c≈©) */
    const TIMER_SEC = 90 * 60;
    let remaining;
    const storedRem = localStorage.getItem('quiz_remaining');
    if(storedRem === null) remaining = TIMER_SEC;
    else { remaining = parseInt(storedRem, 10); if(isNaN(remaining) || remaining < 0) remaining = TIMER_SEC; }

    const timerHeader = document.getElementById('timerHeader');
    const prevResultRaw = localStorage.getItem('quiz_result');
    if(prevResultRaw){
      try{
        const prev = JSON.parse(prevResultRaw);
        showScoreBanner(prev);
        submitted = true;
        lockUI();
        remaining = 0;
        updateTimerDisplay();
      }catch(e){ console.warn('prev parse', e); }
    }

    let interval = null;
    if(!submitted){
      updateTimerDisplay();
      interval = setInterval(()=>{
        if(remaining <= 0){ clearInterval(interval); autoSubmit(); return; }
        remaining--;
        localStorage.setItem('quiz_remaining', remaining);
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay(){
      const m = Math.floor(remaining / 60);
      const s = remaining % 60;
      const txt = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      timerHeader.textContent = txt;
    }

    /* SAVE / LOAD PROGRESS */
    document.getElementById('saveBtn').addEventListener('click', ()=>{ saveProgress(); alert('ƒê√£ l∆∞u t·∫°m (localStorage).'); });
    document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('X√≥a d·ªØ li·ªáu local?')){ localStorage.clear(); location.reload(); } });

    function saveProgress(){
      const data = { mcq:{}, tf:{}, short:{}, flagged, remaining };
      for(let i=1;i<=MCQ_COUNT;i++){ data.mcq[i] = (document.querySelector(`input[name='p1q${i}']:checked`)||{}).value || null; }
      for(let i=1;i<=TF_COUNT;i++){ data.tf[i] = []; for(let j=1;j<=TF_ITEMS;j++){ data.tf[i].push((document.querySelector(`input[name='p2q${i}y${j}']:checked`)||{}).value || null); } }
      for(let i=1;i<=SHORT_COUNT;i++){ data.short[i] = (document.querySelector(`input[name='p3q${i}']`)||{}).value || ''; }
      localStorage.setItem('quiz_saved', JSON.stringify(data)); localStorage.setItem('quiz_remaining', remaining);
    }

    (function loadProgress(){
      const raw = localStorage.getItem('quiz_saved'); if(!raw) return;
      try{
        const data = JSON.parse(raw);
        if(data.mcq) for(let i=1;i<=MCQ_COUNT;i++){ const v = data.mcq[i]; if(v){ const el = document.querySelector(`input[name='p1q${i}'][value='${v}']`); if(el) el.checked = true; } }
        if(data.tf) for(let i=1;i<=TF_COUNT;i++){ for(let j=1;j<=TF_ITEMS;j++){ const v = data.tf[i] && data.tf[i][j-1]; if(v){ const el = document.querySelector(`input[name='p2q${i}y${j}'][value='${v}']`); if(el) el.checked = true; } } }
        if(data.short) for(let i=1;i<=SHORT_COUNT;i++){ const v = data.short[i]; if(v !== ''){ const el = document.querySelector(`input[name='p3q${i}']`); if(el) el.value = v; } }
        if(data.flagged) flagged = data.flagged;
        if(data.remaining) { remaining = Number(data.remaining); updateTimerDisplay(); }
      }catch(e){ console.warn('Kh√¥ng th·ªÉ load progress', e); }
    })();

    /* SCORING */
    function computeScore(){
      let score = 0;
      const breakdown = {
        mcq: { total: MCQ_COUNT, correct:0, score:0, max: MCQ_COUNT * 0.25 },
        tf: { total: TF_COUNT, score:0, details:[], max: TF_COUNT * 1 },
        short: { total: SHORT_COUNT, correct:0, score:0, max: SHORT_COUNT * 0.5 }
      };

      for(let i=1;i<=MCQ_COUNT;i++){
        const user = (document.querySelector(`input[name='p1q${i}']:checked`)||{}).value || null;
        if(user && user === correct.mcq[i]){ breakdown.mcq.correct++; breakdown.mcq.score += 0.25; score += 0.25; }
      }

      for(let i=1;i<=TF_COUNT;i++){
        let correctCount = 0;
        for(let j=1;j<=TF_ITEMS;j++){
          const sel = (document.querySelector(`input[name='p2q${i}y${j}']:checked`)||{}).value;
          if(sel !== undefined && sel !== null && sel !== ''){
            if((sel === 'true') === correct.tf[i][j-1]) correctCount++;
          }
        }
        let pts = 0;
        if(correctCount === 4) pts = 1;
        else if(correctCount === 3) pts = 0.5;
        else if(correctCount === 2) pts = 0.25;
        else if(correctCount === 1) pts = 0.1;
        breakdown.tf.details.push({ q:i, correctCount, pts });
        breakdown.tf.score += pts; score += pts;
      }

      for(let i=1;i<=SHORT_COUNT;i++){
        const v = (document.querySelector(`input[name='p3q${i}']`)||{}).value;
        if(v !== '' && !isNaN(Number(v)) && Number(v) === correct.short[i]){ breakdown.short.correct++; breakdown.short.score += 0.5; score += 0.5; }
      }

      return { score, breakdown };
    }

    /* SHOW SCORE PANEL */
    function showScoreBanner(result){
      const res = (result && result.score !== undefined) ? result : { score: result };
      if(!res.breakdown){
        const comp = computeScore(); res.score = comp.score; res.breakdown = comp.breakdown;
      }
      const maxScore = res.breakdown.mcq.max + res.breakdown.tf.max + res.breakdown.short.max;
      const pct = Math.round((res.score / maxScore) * 10000) / 100;
      const sb = document.getElementById('scoreBanner');
      sb.style.display = 'block';
      sb.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;align-items:center">
          <div class="score-title">ƒêi·ªÉm t·ªïng: <strong style="font-size:20px">${res.score}/${maxScore}</strong> ‚Äî <span class="score-sub">${pct}%</span></div>
          <table class="score-table">
            <thead><tr><th>Ph·∫ßn</th><th>S·ªë c√¢u</th><th>ƒê√∫ng</th><th>ƒêi·ªÉm ƒë·∫°t</th><th>ƒêi·ªÉm t·ªëi ƒëa</th></tr></thead>
            <tbody>
              <tr><td>Tr·∫Øc nghi·ªám (MCQ)</td><td>${res.breakdown.mcq.total}</td><td>${res.breakdown.mcq.correct}</td><td>${res.breakdown.mcq.score}</td><td>${res.breakdown.mcq.max}</td></tr>
              <tr><td>ƒê√∫ng/Sai (TF)</td><td>${res.breakdown.tf.total}</td><td>‚Äî</td><td>${res.breakdown.tf.score.toFixed(2)}</td><td>${res.breakdown.tf.max}</td></tr>
              <tr><td>Tr·∫£ l·ªùi ng·∫Øn</td><td>${res.breakdown.short.total}</td><td>${res.breakdown.short.correct}</td><td>${res.breakdown.short.score}</td><td>${res.breakdown.short.max}</td></tr>
            </tbody>
          </table>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="retryBtn" class="ghost">L√†m l·∫°i b√†i ki·ªÉm tra nha</button>
          </div>
        </div>
      `;
      const retry = document.getElementById('retryBtn');
      if(retry){
        retry.addEventListener('click', ()=>{
          if(confirm('B·∫°n mu·ªën l√†m l·∫°i: x√≥a ƒëi·ªÉm v√† tr·∫£ v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu?')){
            localStorage.removeItem('quiz_saved'); localStorage.removeItem('quiz_remaining'); localStorage.removeItem('quiz_result');
            location.reload();
          }
        });
      }
    }

    /* SUBMIT & LOCK */
    document.getElementById('submitTopBtn').addEventListener('click', ()=>{ if(confirm('B·∫°n ch·∫Øc mu·ªën n·ªôp b√†i?')) doSubmit(); });

    function lockUI(){
      document.getElementById('quizOverlay').classList.remove('hidden');
      document.getElementById('quizOverlay').setAttribute('aria-hidden', 'false');
      document.querySelectorAll('#quizWrapper input, #quizWrapper button, #quizWrapper textarea, #quizWrapper select').forEach(el=>{
        try{ el.disabled = true; el.setAttribute('aria-disabled','true'); }catch(e){}
      });
      try{ document.getElementById('submitTopBtn').disabled = true; }catch(e){}
    }

    function doSubmit(isAuto=false){
      if(submitted) return;
      submitted = true;
      if(interval) clearInterval(interval);
      remaining = 0;
      localStorage.setItem('quiz_remaining', 0);
      saveProgress();
      const res = computeScore();
      showScoreBanner(res);
      lockUI();
      localStorage.setItem('quiz_result', JSON.stringify({ score: res.score, breakdown: res.breakdown, submittedAt: new Date().toISOString() }));
      document.getElementById('scoreBanner').scrollIntoView({ behavior: 'smooth', block: 'start' });
      updateAnsweredCount();
    }

    function autoSubmit(){ if(!submitted) doSubmit(true); }
    window.addEventListener('beforeunload', function(e){ if(!submitted){ try{ remaining = 0; localStorage.setItem('quiz_remaining', 0); autoSubmit(); }catch(err){} } });
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden && !submitted){ try{ remaining = 0; localStorage.setItem('quiz_remaining', 0); autoSubmit(); }catch(e){} } });

    /* FOOTER BUBBLES */
    function buildFooterBubbles(){
      const wrap = document.getElementById('bubblesWrap');
      wrap.innerHTML = '';
      for(let i=1;i<=TOTAL_Q;i++){
        const b = document.createElement('button');
        b.className = 'bubble';
        b.textContent = i;
        b.dataset.qnum = i;
        b.title = 'C√¢u ' + i;
        b.addEventListener('click', ()=>{ scrollToQuestion(i); });
        wrap.appendChild(b);
      }
      for(let i=1;i<=TOTAL_Q;i++) updateFooterBubble(i);
    }
    buildFooterBubbles();

    function isAnswered(qNum){
      if(qNum <= MCQ_COUNT) return !!document.querySelector(`input[name='p1q${qNum}']:checked`);
      else if(qNum <= MCQ_COUNT + TF_COUNT){
        const idx = qNum - MCQ_COUNT;
        for(let j=1;j<=TF_ITEMS;j++) if(document.querySelector(`input[name='p2q${idx}y${j}']:checked`)) return true;
        return false;
      } else {
        const idx = qNum - MCQ_COUNT - TF_COUNT;
        const el = document.querySelector(`input[name='p3q${idx}']`);
        return el && el.value !== '';
      }
    }

    function updateFooterBubble(qNum){
      const btn = document.querySelector(`.bubble[data-qnum='${qNum}']`);
      if(!btn) return;
      btn.classList.remove('done','flagged');
      if(flagged[qNum]) btn.classList.add('flagged');
      else if(isAnswered(qNum)) btn.classList.add('done');
    }

    // C·∫≠p nh·∫≠t s·ªë c√¢u ƒë√£ l√†m / t·ªïng
    function updateAnsweredCount(){
      let done = 0;
      for(let i=1;i<=TOTAL_Q;i++) if(isAnswered(i)) done++;
      const txt = `${done}/${TOTAL_Q}`;
      const dom = document.getElementById('totalQ');
      const foot = document.getElementById('footerTotal');
      if(dom) dom.textContent = txt;
      if(foot) foot.textContent = txt;
    }

    document.addEventListener('change', (e)=>{
      const name = e.target.name;
      if(!name) return;
      let qNum = null;
      if(name.startsWith('p1q')) qNum = Number(name.replace('p1q',''));
      else if(name.startsWith('p2q')){ const m = name.match(/p2q(\d+)y(\d+)/); if(m) qNum = MCQ_COUNT + Number(m[1]); }
      else if(name.startsWith('p3q')) qNum = MCQ_COUNT + TF_COUNT + Number(name.replace('p3q',''));
      if(qNum) updateFooterBubble(qNum);
      updateAnsweredCount();
    });

    /* helper: scroll to question */
    function scrollToQuestion(qNum){
      const el = document.querySelector(`[data-qnum='${qNum}']`);
      if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
    }

    /* INIT: load progress and set initial states */
    (function init(){
      const raw = localStorage.getItem('quiz_saved');
      if(raw){
        try{
          const data = JSON.parse(raw);
          if(data.mcq) for(let i=1;i<=MCQ_COUNT;i++){ const v = data.mcq[i]; if(v){ const el = document.querySelector(`input[name='p1q${i}'][value='${v}']`); if(el) el.checked = true; } }
          if(data.tf) for(let i=1;i<=TF_COUNT;i++) for(let j=1;j<=TF_ITEMS;j++){ const v = data.tf[i] && data.tf[i][j-1]; if(v){ const el = document.querySelector(`input[name='p2q${i}y${j}'][value='${v}']`); if(el) el.checked = true; } }
          if(data.short) for(let i=1;i<=SHORT_COUNT;i++){ const v = data.short[i]; if(v !== ''){ const el = document.querySelector(`input[name='p3q${i}']`); if(el) el.value = v; } }
          if(data.flagged) flagged = data.flagged;
          if(data.remaining) { remaining = Number(data.remaining); updateTimerDisplay(); }
        }catch(e){ console.warn('load saved failed', e); }
      }
      for(let i=1;i<=TOTAL_Q;i++) updateFooterBubble(i);
      updateAnsweredCount();
      enableMcqToggle(); // ensure toggle works if radios were restored
      updateFooterHeight(); // set initial footer height var
      setTimeout(updateFooterHeight, 300);
    })();
  </script>
</body>
</html>
