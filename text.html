<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thi tr·ª±c tuy·∫øn ‚Äî Demo (header removed) ‚Äî Random from Bank</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --white:#ffffff;
      --card:#f7fbff;
      --accent:#0ea5b7;
      --muted:#64748b;
      --success:#10b981;
      --warning:#f59e0b;
      --shadow: 0 10px 30px rgba(2,6,23,0.08);
      --footer-blue-start: #0b2e6b;
      --footer-blue-end: #062969;
      --footer-height: 120px;
      --quiz-font-size: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--white); color:#0b1220}

    .candidate-strip{
      width:100%;
      box-sizing:border-box;
      background:#0f274a; color:#eaf6ff; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; box-shadow:var(--shadow);
    }
    .candidate-inner{ max-width:1400px; margin:0 auto; width:100%; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .candidate-info{ display:flex; gap:14px; align-items:center; font-size:13px; }
    .candidate-info .name{ font-weight:700; color:#fff; }
    .candidate-controls{ display:flex; gap:8px; align-items:center; }
    .btn-primary{ background:var(--accent); color:#042024; border:0; padding:8px 12px; border-radius:8px; font-weight:700; cursor:pointer; }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.12); padding:8px 10px; border-radius:8px; color:#eaf6ff; cursor:pointer; }
    .timer-bubble{ background: rgba(255,255,255,0.08); padding:6px 10px; border-radius:20px; font-weight:700; color:#fff; }

    .page-wrap{
      max-width: none;
      width: calc(100% - 36px);
      margin:18px auto 0;
      padding:18px;
      background:var(--card);
      border-radius:10px;
      box-shadow:var(--shadow);
      padding-bottom: calc(var(--footer-height) + 20px);
    }

    .content h1{ margin:0 0 14px 0; text-align:center; font-size:20px; color:#08263b; }

    .score-panel{ display:none; background:#fff; border-radius:10px; padding:14px; box-shadow: 0 14px 40px rgba(2,6,23,0.08); border:1px solid rgba(2,6,23,0.04); margin-bottom:12px; }
    .score-title{ font-weight:800; font-size:18px; color:#09324a; }
    .score-sub{ color:#334155; font-weight:600 }
    .score-table{ width:100%; border-collapse:collapse; margin-top:10px; color:#334155; }
    .score-table th, .score-table td{ padding:10px; border:1px solid rgba(2,6,23,0.06); text-align:center; }
    .score-table th{ background:rgba(2,6,23,0.02); font-weight:700; }

    .quiz-area{ position:relative; }
    .quiz-wrapper{
      padding:8px 2px;
      max-width:1400px;
      margin:0 auto;
      font-size: var(--quiz-font-size);
      line-height:1.45;
    }
    .question{ background:#fff; border-radius:8px; padding:14px; margin-bottom:14px; border:1px solid rgba(2,6,23,0.04); display:block; box-shadow: 0 6px 20px rgba(2,6,23,0.03); }
    .q-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .q-left{ display:flex; gap:12px; align-items:center; }
    .qnum{ width:44px; height:44px; border-radius:8px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-weight:800; color:#0b1220; font-size:1rem; }
    .qtitle{ font-weight:700; color:#0b1220; font-size:1.125rem; }
    .flag-btn{ background:transparent; border:1px solid rgba(2,6,23,0.05); padding:8px 10px; border-radius:8px; cursor:pointer; font-size:0.98rem; }
    .options{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    label.option{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:8px; border:1px solid rgba(2,6,23,0.04); cursor:pointer; background:#fff; font-size:1rem; }
    input[type="number"]{ padding:10px; border-radius:6px; border:1px solid rgba(2,6,23,0.06); width:200px; font-size:1rem; }

    .tf-table{ width:100%; border-collapse:collapse; table-layout:fixed; margin-top:10px; font-size:1rem; }
    .tf-table th, .tf-table td{ padding:10px; border:1px solid rgba(2,6,23,0.06); vertical-align:middle; }
    .tf-table thead th:nth-child(1){ width:40px; max-width:40px; text-align:center; }
    .tf-table thead th:nth-child(2){ width:auto; }
    .tf-table thead th:nth-child(3), .tf-table thead th:nth-child(4){ width:70px; max-width:70px; text-align:center; }
    .tf-table td:nth-child(2){ white-space:normal; word-wrap:break-word; }

    .quiz-overlay{ position:absolute; inset:0; background:rgba(0,0,0,0.45); z-index:40; display:flex; align-items:center; justify-content:center; border-radius:8px; }
    .quiz-overlay.hidden{ display:none; }
    .quiz-overlay .msg{ background:rgba(255,255,255,0.06); color:#fff; padding:16px 18px; border-radius:8px; font-weight:700; font-size:1rem; }

    .site-footer{ position: fixed; left: 0; right: 0; bottom: 0; background: linear-gradient(180deg, var(--footer-blue-start), var(--footer-blue-end)); padding: 14px 0; display: flex; justify-content: center; z-index: 80; box-shadow: 0 -8px 30px rgba(0,0,0,0.25); }
    .footer-inner{ width: 100%; max-width: 1400px; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; border-radius: 20px; background: linear-gradient(180deg, #0d47a1, #083a8c); box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
    .bubbles-wrap{ display: flex; gap: 8px; align-items: center; flex-wrap:wrap;}
    .bubble{ width: 38px; height: 38px; border-radius: 50%; display: grid; place-items: center; font-weight: 700; cursor: pointer; background: rgba(255,255,255,0.15); color: #fff; border: 2px solid rgba(255,255,255,0.1); font-size:0.98rem; }
    .bubble.done{ background: linear-gradient(180deg,#22c55e,#10b981); color: #07211a; border-color: rgba(0,0,0,0.09); }
    .bubble.flagged{ background: linear-gradient(180deg,#f59e0b,#f97316); color: #2b1700; border-color: rgba(0,0,0,0.09); }
    .footer-note{ color: #fff; font-size: 14px; margin-left: 12px; opacity: 0.95; }

    .controls{ display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-bottom:12px; }
    .primary{ background:var(--accent); color:#042024; padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    .ghost{ background:transparent; border:1px solid rgba(2,6,23,0.06); padding:8px 12px; border-radius:8px; cursor:pointer; }

    @media (max-width:900px){
      .candidate-inner{ flex-direction:column; align-items:flex-start; gap:8px; }
      .page-wrap{ width: calc(100% - 20px); margin:12px; padding:12px; }
      .footer-inner{ padding:6px }
      .bubble{ width:30px; height:30px; font-size:13px }
      .tf-table thead th:nth-child(1), .tf-table thead th:nth-child(3), .tf-table thead th:nth-child(4){ width:28px; }
      .quiz-wrapper{ font-size: 16px; }
      .qnum{ width:36px; height:36px; font-size:0.95rem; }
    }
  </style>
</head>
<body>
  <div class="candidate-strip" role="region" aria-label="Th√¥ng tin th√≠ sinh">
    <div class="candidate-inner">
      <div class="candidate-info">
        <div class="name" id="candName">Nguy·ªÖn VƒÉn A</div>
        <div>SBD: <strong id="candSBD">00000001</strong></div>
        <div>M√¥n thi: <strong id="candSub">TO√ÅN H·ªåC</strong></div>
        <div>Ng√†y thi: <strong id="candDate">10/09/2025</strong></div>
        <div>Ca thi: <strong id="candShift">8</strong></div>
      </div>

      <div class="candidate-controls">
        <div class="timer-bubble" id="timerHeader">90:00</div>
        <button class="btn-ghost" id="connStatus">üîå ƒêang k·∫øt n·ªëi</button>
        <button class="btn-ghost" id="reshuffleBtn" title="L·∫•y ƒë·ªÅ ng·∫´u nhi√™n m·ªõi">üîÄ L·∫•y ƒë·ªÅ ng·∫´u nhi√™n m·ªõi</button>
        <button class="btn-primary" id="submitTopBtn">N·ªòP B√ÄI</button>
        <button class="btn-ghost" title="To√†n m√†n h√¨nh" onclick="document.documentElement.requestFullscreen()">‚§¢</button>
      </div>
    </div>
  </div>

  <main class="page-wrap" id="pageWrap">
    <div class="content panel" id="contentPanel">
      <h1>GIAO DI·ªÜN L√ÄM B√ÄI C·ª¶A TH√ç SINH</h1>
      <section id="scoreBanner" class="score-panel" aria-live="polite"></section>

      <div class="controls">
        <div style="color:var(--muted); align-self:center">ƒê√£ l√†m: <strong id="totalQ">0/...</strong></div>
        <button class="ghost" id="saveBtn">L∆∞u t·∫°m</button>
        <button class="ghost" id="clearBtn">X√≥a d·ªØ li·ªáu</button>
      </div>

      <section class="quiz-area">
        <div class="quiz-wrapper" id="quizWrapper">
          <form id="quizForm" autocomplete="off">
            <div id="part1" class="section"><h3>Ph·∫ßn 1. Tr·∫Øc nghi·ªám</h3></div>
            <div id="part2" class="section"><h3>Ph·∫ßn 2. ƒê√∫ng/Sai (m·ªói c√¢u c√≥ 4 √Ω)</h3></div>
            <div id="part3" class="section"><h3>Ph·∫ßn 3. Tr·∫£ l·ªùi ng·∫Øn</h3></div>
          </form>
        </div>

        <div id="quizOverlay" class="quiz-overlay hidden" aria-hidden="true"><div class="msg">B√†i ƒë√£ n·ªôp ‚Äî kh√¥ng th·ªÉ ch·ªânh s·ª≠a n·ªØa</div></div>
      </section>
    </div>
  </main>

  <footer class="site-footer" role="contentinfo" id="siteFooter">
    <div class="footer-inner" id="footerBubbles">
      <div class="bubbles-wrap" id="bubblesWrap"></div>
      <div class="footer-note" id="footerNote">ƒê√£ l√†m: <span id="footerTotal">0/...</span></div>
    </div>
  </footer>

  <script>
    /* ===== CONFIG ===== */
    const MCQ_COUNT = 12;
    const TF_COUNT = 4;
    const TF_ITEMS = 4;
    const SHORT_COUNT = 6;
    const TOTAL_Q = MCQ_COUNT + TF_COUNT + SHORT_COUNT;

    /* ===== YOUR QUESTION BANKS (replace with your ~100 items each) =====
       Format examples below. Replace the sample arrays with your full banks.
    */
    const MCQ_BANK = [
     { id:"mcq-001", q:"1+1 = ?", choices:{A:"1", B:"2", C:"3", D:"4"}, correct:"B" },
  { id:"mcq-002", q:"2+3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"HELLO = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+3√¢ = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+s3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+3s = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+d3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+f3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+∆∞3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+d3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+3f = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+g3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+h3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+3e = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+∆∞3 = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+3g = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+3b = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },
 { id:"mcq-002", q:"2+3e = ?", choices:{A:"5", B:"4", C:"3", D:"2"}, correct:"A" },

    ];

    const TF_BANK = [
     { id:"tf-001", topic:"S·ªë nguy√™n", statements:["1 l√† l·∫ª","2 l√† ch·∫µn","0 l√† s·ªë √¢m?","-1<0"], truths:[true,true,false,true] },
      { topic: "TF sample 2", statements: ["S2.1", "S2.2", "S2.3", "S2.4"] },
      { topic: "TF sample 3", statements: ["S3.1", "S3.2", "S3.3", "S3.4"] },
      { topic: "TF sample 4", statements: ["S4.1", "S4.2", "S4.3", "S4.4"] },
      { topic: "TF sample 5", statements: ["S5.1", "S5.2", "S5.3", "S5.4"] }
      /* ... up to ~100 entries ... */
    ];

    const SHORT_BANK = [
    { id:"short-001", q:"T·ªïng 5 + 7 = ?", answer:12 },
      { q: "Short sample 2: T√≠nh ...", answer: 180 },
      { q: "Short sample 3: T√≠nh ...", answer: 42 },
      { q: "Short sample 4: T√≠nh ...", answer: 7 },
      { q: "Short sample 5: T√≠nh ...", answer: 100 }
      /* ... up to ~100 entries ... */
    ];
    /* ===== END BANKS ===== */

    /* ===== STATE ===== */
    let flagged = {};
    let submitted = false;
    // selected questions arrays (after drawing from bank)
    let selectedMCQs = [];
    let selectedTFs = [];
    let selectedShorts = [];

    /* LOAD selection if exists (so same exam persists) */
    function loadSelectedFromStorage(){
      const raw = localStorage.getItem('quiz_selected');
      if(!raw) return false;
      try{
        const s = JSON.parse(raw);
        if(Array.isArray(s.mcq) && Array.isArray(s.tf) && Array.isArray(s.short)){
          selectedMCQs = s.mcq;
          selectedTFs = s.tf;
          selectedShorts = s.short;
          return true;
        }
      }catch(e){ console.warn('loadSelectedFromStorage', e); }
      return false;
    }

    /* Save selected sets */
    function saveSelectedToStorage(){
      const payload = { mcq: selectedMCQs, tf: selectedTFs, short: selectedShorts };
      localStorage.setItem('quiz_selected', JSON.stringify(payload));
    }

    /* Utility: Fisher-Yates shuffle */
    function shuffleArray(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    /* Draw random sample without duplicates */
    function drawFromBank(){
      // Ensure bank sizes are sufficient
      if(MCQ_BANK.length < MCQ_COUNT || TF_BANK.length < TF_COUNT || SHORT_BANK.length < SHORT_COUNT){
        console.warn('Warning: your banks have fewer items than required counts.');
      }

      const mcqPool = shuffleArray(MCQ_BANK);
      const tfPool = shuffleArray(TF_BANK);
      const shortPool = shuffleArray(SHORT_BANK);

      selectedMCQs = mcqPool.slice(0, MCQ_COUNT).map((it, idx) => {
        // include an id for reference if needed
        return Object.assign({ _bankIndex: idx }, it);
      });
      selectedTFs = tfPool.slice(0, TF_COUNT).map((it, idx) => Object.assign({ _bankIndex: idx }, it));
      selectedShorts = shortPool.slice(0, SHORT_COUNT).map((it, idx) => Object.assign({ _bankIndex: idx }, it));
      saveSelectedToStorage();
    }

    /* If stored selection exists, load it; else draw new */
    function ensureSelection(){
      const ok = loadSelectedFromStorage();
      if(!ok){
        drawFromBank();
      }
    }

    /* DOM initial text */
    document.getElementById('totalQ').textContent = `0/${TOTAL_Q}`;
    document.getElementById('footerTotal').textContent = `0/${TOTAL_Q}`;

    /* RENDER QUESTIONS from selected arrays */
    function renderQuestions(){
      const part1 = document.getElementById('part1'); part1.innerHTML = '<h3>Ph·∫ßn 1. Tr·∫Øc nghi·ªám</h3>';
      const part2 = document.getElementById('part2'); part2.innerHTML = '<h3>Ph·∫ßn 2. ƒê√∫ng/Sai (m·ªói c√¢u c√≥ 4 √Ω)</h3>';
      const part3 = document.getElementById('part3'); part3.innerHTML = '<h3>Ph·∫ßn 3. Tr·∫£ l·ªùi ng·∫Øn</h3>';

      // MCQ
      for(let i=0;i<MCQ_COUNT;i++){
        const item = selectedMCQs[i] || { q: `MCQ missing ${i+1}`, choices: { A:'',B:'',C:'',D:'' } };
        const qNum = i+1;
        const q = document.createElement('div'); q.className='question'; q.dataset.qnum = qNum;
        q.innerHTML = `
          <div class="q-head">
            <div class="q-left"><div class="qnum">${qNum}</div><div class="qtitle">C√¢u ${qNum}: ${escapeHtml(item.q)}</div></div>
            <div><button type="button" class="flag-btn" onclick="toggleFlag(${qNum}, this)">üö© G·∫Øn c·ªù</button></div>
          </div>
          <div class="options">
            <label class="option"><input type="radio" name="p1q${qNum}" value="A"> A. ${escapeHtml(item.choices.A||'')}</label>
            <label class="option"><input type="radio" name="p1q${qNum}" value="B"> B. ${escapeHtml(item.choices.B||'')}</label>
            <label class="option"><input type="radio" name="p1q${qNum}" value="C"> C. ${escapeHtml(item.choices.C||'')}</label>
            <label class="option"><input type="radio" name="p1q${qNum}" value="D"> D. ${escapeHtml(item.choices.D||'')}</label>
          </div>`;
        part1.appendChild(q);
      }

      // TF (each item has 4 statements)
      for(let i=0;i<TF_COUNT;i++){
        const baseNum = MCQ_COUNT + i + 1;
        const item = selectedTFs[i] || { topic: `TF missing ${i+1}`, statements: ["","","",""] };
        const q = document.createElement('div'); q.className='question'; q.dataset.qnum = baseNum;
        let table = `<table class="tf-table"><thead><tr><th>√ù</th><th>Ph√°t bi·ªÉu</th><th>ƒê√∫ng</th><th>Sai</th></tr></thead><tbody>`;
        for(let j=0;j<TF_ITEMS;j++){
          table += `<tr><td style="padding:8px;text-align:center">${String.fromCharCode(97+j)}</td><td style="padding:8px">${escapeHtml(item.statements[j]||'')}</td><td style="padding:8px;text-align:center"><input type="radio" name="p2q${i+1}y${j+1}" value="true"></td><td style="padding:8px;text-align:center"><input type="radio" name="p2q${i+1}y${j+1}" value="false"></td></tr>`;
        }
        table += '</tbody></table>';
        q.innerHTML = `
          <div class="q-head">
            <div class="q-left"><div class="qnum">${baseNum}</div><div class="qtitle">C√¢u ${baseNum}: ${escapeHtml(item.topic)}</div></div>
            <div><button type="button" class="flag-btn" onclick="toggleFlag(${baseNum}, this)">üö© G·∫Øn c·ªù</button></div>
          </div>
          <div style="margin-top:8px">${table}</div>`;
        part2.appendChild(q);
      }

      // Short answers
      for(let i=0;i<SHORT_COUNT;i++){
        const qNum = MCQ_COUNT + TF_COUNT + i + 1;
        const item = selectedShorts[i] || { q: `Short missing ${i+1}`, answer: null };
        const q = document.createElement('div'); q.className='question'; q.dataset.qnum = qNum;
        q.innerHTML = `
          <div class="q-head">
            <div class="q-left"><div class="qnum">${qNum}</div><div class="qtitle">C√¢u ${qNum}: ${escapeHtml(item.q)}</div></div>
            <div><button type="button" class="flag-btn" onclick="toggleFlag(${qNum}, this)">üö© G·∫Øn c·ªù</button></div>
          </div>
          <div style="margin-top:8px"><input type="number" name="p3q${i+1}" placeholder="Nh·∫≠p ƒë√°p √°n d·∫°ng s·ªë"></div>`;
        part3.appendChild(q);
      }

      enableMcqToggle();
      enableFocusScrolling();
      buildFooterBubbles();
      // after rendering, try to restore saved answers if any
      loadProgressAnswersIntoUI();
      updateAnsweredCount();
    }

    /* Escape HTML to avoid accidental injection from banks */
    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    /* MCQ uncheck toggle */
    function enableMcqToggle(){
      const radios = document.querySelectorAll("input[type='radio'][name^='p1q']");
      radios.forEach(radio=>{
        radio.addEventListener('mousedown', function(){ this._wasChecked = this.checked; });
        radio.addEventListener('click', function(e){
          if(this._wasChecked){
            this.checked = false;
            this.dispatchEvent(new Event('change', { bubbles: true }));
            e.preventDefault();
          }
        });
      });
    }

    /* focus scroll to avoid footer covering input */
    function enableFocusScrolling(){
      const inputs = document.querySelectorAll('#quizWrapper input, #quizWrapper textarea, #quizWrapper select');
      inputs.forEach(inp=>{
        inp.addEventListener('focus', (ev)=>{
          setTimeout(()=>{
            const footerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--footer-height')) || 120;
            const rect = inp.getBoundingClientRect();
            const viewportAvailable = window.innerHeight - footerH - 24;
            if(rect.bottom > viewportAvailable){
              const delta = rect.bottom - viewportAvailable + 12;
              window.scrollBy({ top: delta, behavior: 'smooth' });
            }
          }, 80);
        }, {passive:true});
      });
    }

    /* FLAG */
    function toggleFlag(qNum, btn){
      flagged[qNum] = !flagged[qNum];
      if(btn){ btn.textContent = flagged[qNum] ? 'üö© B·ªè c·ªù' : 'üö© G·∫Øn c·ªù'; }
      updateFooterBubble(qNum);
      updateAnsweredCount();
    }
    window.toggleFlag = toggleFlag;

    /* FOOTER & BUBBLES */
    function buildFooterBubbles(){
      const wrap = document.getElementById('bubblesWrap');
      wrap.innerHTML = '';
      for(let i=1;i<=TOTAL_Q;i++){
        const b = document.createElement('button');
        b.className = 'bubble';
        b.textContent = i;
        b.dataset.qnum = i;
        b.title = 'C√¢u ' + i;
        b.addEventListener('click', ()=>{ scrollToQuestion(i); });
        wrap.appendChild(b);
      }
      for(let i=1;i<=TOTAL_Q;i++) updateFooterBubble(i);
    }

    function isAnswered(qNum){
      if(qNum <= MCQ_COUNT) return !!document.querySelector(`input[name='p1q${qNum}']:checked`);
      else if(qNum <= MCQ_COUNT + TF_COUNT){
        const idx = qNum - MCQ_COUNT;
        for(let j=1;j<=TF_ITEMS;j++) if(document.querySelector(`input[name='p2q${idx}y${j}']:checked`)) return true;
        return false;
      } else {
        const idx = qNum - MCQ_COUNT - TF_COUNT;
        const el = document.querySelector(`input[name='p3q${idx}']`);
        return el && el.value !== '';
      }
    }

    function updateFooterBubble(qNum){
      const btn = document.querySelector(`.bubble[data-qnum='${qNum}']`);
      if(!btn) return;
      btn.classList.remove('done','flagged');
      if(flagged[qNum]) btn.classList.add('flagged');
      else if(isAnswered(qNum)) btn.classList.add('done');
    }

    function updateAnsweredCount(){
      let done = 0;
      for(let i=1;i<=TOTAL_Q;i++) if(isAnswered(i)) done++;
      const txt = `${done}/${TOTAL_Q}`;
      const dom = document.getElementById('totalQ'); const foot = document.getElementById('footerTotal');
      if(dom) dom.textContent = txt;
      if(foot) foot.textContent = txt;
    }

    document.addEventListener('change', (e)=>{
      const name = e.target.name;
      if(!name) return;
      let qNum = null;
      if(name.startsWith('p1q')) qNum = Number(name.replace('p1q',''));
      else if(name.startsWith('p2q')){ const m = name.match(/p2q(\d+)y(\d+)/); if(m) qNum = MCQ_COUNT + Number(m[1]); }
      else if(name.startsWith('p3q')) qNum = MCQ_COUNT + TF_COUNT + Number(name.replace('p3q',''));
      if(qNum) updateFooterBubble(qNum);
      updateAnsweredCount();
    });

    function scrollToQuestion(qNum){
      const el = document.querySelector(`[data-qnum='${qNum}']`);
      if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
    }

    /* SAVE / LOAD PROGRESS (answers) */
    function saveProgress(){
      const data = { mcq:{}, tf:{}, short:{}, flagged, remaining };
      for(let i=1;i<=MCQ_COUNT;i++){ data.mcq[i] = (document.querySelector(`input[name='p1q${i}']:checked`)||{}).value || null; }
      for(let i=1;i<=TF_COUNT;i++){ data.tf[i] = []; for(let j=1;j<=TF_ITEMS;j++){ data.tf[i].push((document.querySelector(`input[name='p2q${i}y${j}']:checked`)||{}).value || null); } }
      for(let i=1;i<=SHORT_COUNT;i++){ data.short[i] = (document.querySelector(`input[name='p3q${i}']`)||{}).value || ''; }
      // also save the selected set so reload keeps same exam
      const payload = { selectedMCQs, selectedTFs, selectedShorts };
      localStorage.setItem('quiz_saved', JSON.stringify(data));
      localStorage.setItem('quiz_selected', JSON.stringify({ mcq: selectedMCQs, tf: selectedTFs, short: selectedShorts }));
      localStorage.setItem('quiz_remaining', remaining);
    }

    function loadProgressAnswersIntoUI(){
      const raw = localStorage.getItem('quiz_saved'); if(!raw) return;
      try{
        const data = JSON.parse(raw);
        if(data.mcq) for(let i=1;i<=MCQ_COUNT;i++){ const v = data.mcq[i]; if(v){ const el = document.querySelector(`input[name='p1q${i}'][value='${v}']`); if(el) el.checked = true; } }
        if(data.tf) for(let i=1;i<=TF_COUNT;i++){ for(let j=1;j<=TF_ITEMS;j++){ const v = data.tf[i] && data.tf[i][j-1]; if(v){ const el = document.querySelector(`input[name='p2q${i}y${j}'][value='${v}']`); if(el) el.checked = true; } } }
        if(data.short) for(let i=1;i<=SHORT_COUNT;i++){ const v = data.short[i]; if(v !== ''){ const el = document.querySelector(`input[name='p3q${i}']`); if(el) el.value = v; } }
        if(data.flagged) flagged = data.flagged;
        if(data.remaining) { remaining = Number(data.remaining); updateTimerDisplay(); }
      }catch(e){ console.warn('Kh√¥ng th·ªÉ load progress', e); }
      // update footer/answered markers according to restored answers
      for(let i=1;i<=TOTAL_Q;i++) updateFooterBubble(i);
      updateAnsweredCount();
    }

    document.getElementById('saveBtn').addEventListener('click', ()=>{ saveProgress(); alert('ƒê√£ l∆∞u t·∫°m (localStorage).'); });
    document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('X√≥a d·ªØ li·ªáu local?')){ localStorage.clear(); location.reload(); } });

    /* SCORING logic (unchanged) */
function computeScore(){
  let score = 0;
  const breakdown = {
    mcq: { total: MCQ_COUNT, correct:0, score:0, max: MCQ_COUNT * 0.25 },
    tf: { total: TF_COUNT, score:0, details:[], max: TF_COUNT * 1 },
    short: { total: SHORT_COUNT, correct:0, score:0, max: SHORT_COUNT * 0.5 }
  };

  // MCQ
  for(let i=1;i<=MCQ_COUNT;i++){
    const user = (document.querySelector(`input[name='p1q${i}']:checked`)||{}).value || null;
    const bankItem = selectedMCQs[i-1];
    if(user && bankItem && bankItem.correct && user === bankItem.correct){
      breakdown.mcq.correct++;
      breakdown.mcq.score += 0.25;
      score += 0.25;
    }
  }

  // TF
  for(let i=1;i<=TF_COUNT;i++){
    const bankItem = selectedTFs[i-1];
    let correctCount = 0;
    if(bankItem && Array.isArray(bankItem.truths)){
      for(let j=1;j<=TF_ITEMS;j++){
        const sel = (document.querySelector(`input[name='p2q${i}y${j}']:checked`)||{}).value;
        if(sel !== undefined && sel !== null && sel !== ''){
          if((sel === 'true') === Boolean(bankItem.truths[j-1])) correctCount++;
        }
      }
    }
    let pts = 0;
    if(correctCount === 4) pts = 1;
    else if(correctCount === 3) pts = 0.5;
    else if(correctCount === 2) pts = 0.25;
    else if(correctCount === 1) pts = 0.1;
    breakdown.tf.details.push({ q:i, correctCount, pts });
    breakdown.tf.score += pts;
    score += pts;
  }

  // SHORT
  for(let i=1;i<=SHORT_COUNT;i++){
    const v = (document.querySelector(`input[name='p3q${i}']`)||{}).value;
    const bankItem = selectedShorts[i-1];
    if(bankItem && bankItem.answer !== undefined && v !== '' && !isNaN(Number(v))){
      const expected = Number(bankItem.answer);
      const tol = Number(bankItem.tolerance || 0);
      const numv = Number(v);
      if(Math.abs(numv - expected) <= tol){
        breakdown.short.correct++;
        breakdown.short.score += 0.5;
        score += 0.5;
      }
    }
  }

  return { score, breakdown };
}


    /* Score banner display (same as before) */
    function showScoreBanner(result){
      const res = (result && result.score !== undefined) ? result : { score: result };
      if(!res.breakdown){
        const comp = computeScore(); res.score = comp.score; res.breakdown = comp.breakdown;
      }
      const maxScore = res.breakdown.mcq.max + res.breakdown.tf.max + res.breakdown.short.max;
      const pct = Math.round((res.score / maxScore) * 10000) / 100;
      const sb = document.getElementById('scoreBanner');
      sb.style.display = 'block';
      sb.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:10px;align-items:center">
          <div class="score-title">ƒêi·ªÉm t·ªïng: <strong style="font-size:20px">${res.score}/${maxScore}</strong> ‚Äî <span class="score-sub">${pct}%</span></div>
          <table class="score-table">
            <thead><tr><th>Ph·∫ßn</th><th>S·ªë c√¢u</th><th>ƒê√∫ng</th><th>ƒêi·ªÉm ƒë·∫°t</th><th>ƒêi·ªÉm t·ªëi ƒëa</th></tr></thead>
            <tbody>
              <tr><td>Tr·∫Øc nghi·ªám (MCQ)</td><td>${res.breakdown.mcq.total}</td><td>${res.breakdown.mcq.correct}</td><td>${res.breakdown.mcq.score}</td><td>${res.breakdown.mcq.max}</td></tr>
              <tr><td>ƒê√∫ng/Sai (TF)</td><td>${res.breakdown.tf.total}</td><td>‚Äî</td><td>${res.breakdown.tf.score.toFixed(2)}</td><td>${res.breakdown.tf.max}</td></tr>
              <tr><td>Tr·∫£ l·ªùi ng·∫Øn</td><td>${res.breakdown.short.total}</td><td>${res.breakdown.short.correct}</td><td>${res.breakdown.short.score}</td><td>${res.breakdown.short.max}</td></tr>
            </tbody>
          </table>
          <div style="display:flex;gap:8px;margin-top:6px">
            <button id="retryBtn" class="ghost">L√†m l·∫°i b√†i ki·ªÉm tra nha</button>
          </div>
        </div>
      `;
      const retry = document.getElementById('retryBtn');
      if(retry){
        retry.addEventListener('click', ()=>{
          if(confirm('B·∫°n mu·ªën l√†m l·∫°i: x√≥a ƒëi·ªÉm v√† tr·∫£ v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu?')){
            localStorage.removeItem('quiz_saved'); localStorage.removeItem('quiz_remaining'); localStorage.removeItem('quiz_result'); localStorage.removeItem('quiz_selected');
            location.reload();
          }
        });
      }
    }

    /* SUBMIT & LOCK */
    document.getElementById('submitTopBtn').addEventListener('click', ()=>{ if(confirm('B·∫°n ch·∫Øc mu·ªën n·ªôp b√†i?')) doSubmit(); });

    function lockUI(){
      document.getElementById('quizOverlay').classList.remove('hidden');
      document.getElementById('quizOverlay').setAttribute('aria-hidden', 'false');
      document.querySelectorAll('#quizWrapper input, #quizWrapper button, #quizWrapper textarea, #quizWrapper select').forEach(el=>{
        try{ el.disabled = true; el.setAttribute('aria-disabled','true'); }catch(e){}
      });
      try{ document.getElementById('submitTopBtn').disabled = true; }catch(e){}
    }

    function doSubmit(isAuto=false){
      if(submitted) return;
      submitted = true;
      if(interval) clearInterval(interval);
      remaining = 0;
      localStorage.setItem('quiz_remaining', 0);
      saveProgress();
      const res = computeScore();
      showScoreBanner(res);
      lockUI();
      localStorage.setItem('quiz_result', JSON.stringify({ score: res.score, breakdown: res.breakdown, submittedAt: new Date().toISOString() }));
      document.getElementById('scoreBanner').scrollIntoView({ behavior: 'smooth', block: 'start' });
      updateAnsweredCount();
    }

    function autoSubmit(){ if(!submitted) doSubmit(true); }
    window.addEventListener('beforeunload', function(e){ if(!submitted){ try{ remaining = 0; localStorage.setItem('quiz_remaining', 0); autoSubmit(); }catch(err){} } });
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden && !submitted){ try{ remaining = 0; localStorage.setItem('quiz_remaining', 0); autoSubmit(); }catch(e){} } });

    /* TIMER (same) */
    const TIMER_SEC = 90 * 60;
    let remaining;
    const storedRem = localStorage.getItem('quiz_remaining');
    if(storedRem === null) remaining = TIMER_SEC;
    else { remaining = parseInt(storedRem, 10); if(isNaN(remaining) || remaining < 0) remaining = TIMER_SEC; }
    const timerHeader = document.getElementById('timerHeader');
    const prevResultRaw = localStorage.getItem('quiz_result');
    if(prevResultRaw){
      try{
        const prev = JSON.parse(prevResultRaw);
        showScoreBanner(prev);
        submitted = true;
        lockUI();
        remaining = 0;
        updateTimerDisplay();
      }catch(e){ console.warn('prev parse', e); }
    }
    let interval = null;
    if(!submitted){
      updateTimerDisplay();
      interval = setInterval(()=>{
        if(remaining <= 0){ clearInterval(interval); autoSubmit(); return; }
        remaining--;
        localStorage.setItem('quiz_remaining', remaining);
        updateTimerDisplay();
      }, 1000);
    }
    function updateTimerDisplay(){
      const m = Math.floor(remaining / 60);
      const s = remaining % 60;
      const txt = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      timerHeader.textContent = txt;
    }

    /* FOOTER height handling so last inputs not covered */
    function updateFooterHeight(){
      const footer = document.getElementById('siteFooter');
      if(!footer) return;
      const h = footer.offsetHeight || 120;
      document.documentElement.style.setProperty('--footer-height', h + 'px');
    }
    window.addEventListener('resize', ()=>{ updateFooterHeight(); });
    window.addEventListener('load', ()=>{ updateFooterHeight(); setTimeout(updateFooterHeight, 300); });

    /* On page load: ensure selection exists, then render questions, then load saved answers */
    (function init(){
      ensureSelection();
      renderQuestions();
      loadProgressAnswersIntoUI();
      for(let i=1;i<=TOTAL_Q;i++) updateFooterBubble(i);
      updateAnsweredCount();
      enableMcqToggle();
    })();

    /* Reshuffle button behavior - will create a new random selection and re-render (warning: will overwrite saved selection & saved answers) */
    document.getElementById('reshuffleBtn').addEventListener('click', ()=>{
      if(confirm('L·∫•y ƒë·ªÅ ng·∫´u nhi√™n m·ªõi s·∫Ω thay th·∫ø ƒë·ªÅ hi·ªán t·∫°i v√† x√≥a c√°c c√¢u tr·∫£ l·ªùi ƒëang l∆∞u. Ti·∫øp t·ª•c?')){
        // clear saved answers & selection
        localStorage.removeItem('quiz_saved');
        localStorage.removeItem('quiz_selected');
        drawFromBank();
        renderQuestions();
        saveProgress(); // persist empty answers for new selection
        alert('ƒê√£ l·∫•y ƒë·ªÅ m·ªõi.');
      }
    });

    /* Helper: load progress into UI already implemented above (loadProgressAnswersIntoUI) */

    /* Utility: if you want an example correct mapping you can define "correct" similar to previous files.
       For automatic grading, provide a correct mapping that matches the selected questions' order or store correct answer inside bank objects.
       e.g. for MCQ_BANK items you could add property "correct: 'A'". If you do, update computeScore to consult selectedMCQs[i].correct
    */

  </script>
</body>
</html>
